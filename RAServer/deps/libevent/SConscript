# -*- mode: python -*-

import os

Import('env')
env = env.Clone()

pwd = Dir('.')
config_command = """
cd '%s' && ./configure --prefix='%s' CC='%s' CFLAGS='-g -fPIC'
""" % (pwd.abspath, env["install_path"], env["CC"])

build_command = "cd '%s' && touch * && make install" % (pwd.abspath,)

sources = [
    'evthread-internal.h',
    'event_iocp.c',
    'SConscript',
    'Makefile.in',
    'bufferevent.c',
    'evbuffer-internal.h',
    'WIN32-Code/tree.h',
    'WIN32-Code/event2/event-config.h',
    'sample/Makefile.in',
    'sample/event-test.c',
    'sample/dns-example.c',
    'sample/le-proxy.c',
    'sample/Makefile.am',
    'sample/time-test.c',
    'sample/http-server.c',
    'sample/signal-test.c',
    'sample/hello-world.c',
    'event_tagging.c',
    'm4/ac_backport_259_ssizet.m4',
    'm4/libtool.m4',
    'm4/ltversion.m4',
    'm4/lt~obsolete.m4',
    'm4/acx_pthread.m4',
    'm4/ltsugar.m4',
    'm4/ltoptions.m4',
    'evdns.c',
    'config.guess',
    'bufferevent_sock.c',
    'epoll.c',
    'kqueue.c',
    'select.c',
    'evmap-internal.h',
    'win32select.c',
    'event.h',
    'devpoll.c',
    'log.c',
    'libevent_pthreads.pc.in',
    'listener.c',
    'Makefile.am',
    'compile',
    'bufferevent-internal.h',
    'evrpc.c',
    'ipv6-internal.h',
    'make-event-config.sed',
    'evthread_pthread.c',
    'bufferevent_ratelim.c',
    'configure',
    'evutil.h',
    'autogen.sh',
    'log-internal.h',
    'evthread_win32.c',
    'evport.c',
    'changelist-internal.h',
    'compat/sys/queue.h',
    'ht-internal.h',
    'configure.ac',
    'evthread.c',
    'poll.c',
    'epoll_sub.c',
    'ratelim-internal.h',
    'minheap-internal.h',
    'LICENSE',
    'evrpc-internal.h',
    'test/regress_iocp.c',
    'test/test-weof.c',
    'test/Makefile.in',
    'test/test-changelist.c',
    'test/test-ratelim.c',
    'test/tinytest_macros.h',
    'test/regress_buffer.c',
    'test/regress_main.c',
    'test/bench_cascade.c',
    'test/regress_testutils.c',
    'test/regress_zlib.c',
    'test/regress.rpc',
    'test/Makefile.am',
    'test/bench_httpclient.c',
    'test/regress_ssl.c',
    'test/regress_thread.c',
    'test/regress.h',
    'test/regress.gen.c',
    'test/regress.gen.h',
    'test/regress_rpc.c',
    'test/regress_bufferevent.c',
    'test/regress_listener.c',
    'test/bench.c',
    'test/tinytest.h',
    'test/rpcgen_wrapper.sh',
    'test/test-eof.c',
    'test/regress_dns.c',
    'test/test-time.c',
    'test/bench_http.c',
    'test/regress_util.c',
    'test/tinytest_local.h',
    'test/regress_http.c',
    'test/regress.c',
    'test/test.sh',
    'test/Makefile.nmake',
    'test/tinytest.c',
    'test/regress_minheap.c',
    'test/regress_testutils.h',
    'test/regress_et.c',
    'test/test-init.c',
    'Doxyfile',
    'evutil.c',
    'README',
    'arc4random.c',
    'util-internal.h',
    'libevent_openssl.pc.in',
    'buffer.c',
    'strlcpy-internal.h',
    'bufferevent_openssl.c',
    'install-sh',
    'buffer_iocp.c',
    'evdns.h',
    'bufferevent_async.c',
    'signal.c',
    'iocp-internal.h',
    'strlcpy.c',
    'evsignal-internal.h',
    'http.c',
    'evhttp.h',
    'depcomp',
    'libevent.pc.in',
    'bufferevent_filter.c',
    'evmap.c',
    'aclocal.m4',
    'evrpc.h',
    'ltmain.sh',
    'config.h.in',
    'evutil_rand.c',
    'defer-internal.h',
    'Makefile.nmake',
    'event_rpcgen.py',
    'whatsnew-2.0.txt',
    'event-internal.h',
    'config.sub',
    'mm-internal.h',
    'event.c',
    'bufferevent_pair.c',
    'include/Makefile.in',
    'include/Makefile.am',
    'include/event2/rpc_compat.h',
    'include/event2/tag_compat.h',
    'include/event2/http_struct.h',
    'include/event2/thread.h',
    'include/event2/bufferevent_compat.h',
    'include/event2/rpc_struct.h',
    'include/event2/rpc.h',
    'include/event2/dns.h',
    'include/event2/event.h',
    'include/event2/bufferevent.h',
    'include/event2/http_compat.h',
    'include/event2/dns_compat.h',
    'include/event2/http.h',
    'include/event2/event_compat.h',
    'include/event2/buffer_compat.h',
    'include/event2/bufferevent_struct.h',
    'include/event2/keyvalq_struct.h',
    'include/event2/event_struct.h',
    'include/event2/tag.h',
    'include/event2/bufferevent_ssl.h',
    'include/event2/dns_struct.h',
    'include/event2/listener.h',
    'include/event2/util.h',
    'include/event2/buffer.h',
    'ChangeLog',
    'missing',
    'http-internal.h',
]

config = env.Command(target = ['Makefile', 'config.h'], source = sources, action = config_command)
libevent = env.Command(target = [os.path.join(env["install_path"], 'lib/libevent.a'),
                                 os.path.join(env["install_path"], 'lib/libevent.so'),
                                 os.path.join(env["install_path"], 'include/event2/event-config.h')],
                       source = sources + [config], action = build_command)
Return('libevent')
