# -*- mode: python -*-

import os

Import('env')
env = env.Clone()

pwd = Dir('.')
config_command = """
cd '%s' && ./configure --prefix='%s' CC='%s' CFLAGS='-g -fPIC'
""" % (pwd.abspath, env["install_path"], env["CC"])

build_command = "cd '%s' && touch * && make -C lib install && make -C include install" % (pwd.abspath,)

sources = [
    Glob('*/Makefile.in'),
    Glob('*/*/Makefile.in'),
    Glob('*/*/*/Makefile.in'),
    Glob('*/*/*/*/Makefile.in'),
    Glob('packages/*/*.in'),
    Glob('packages/*/*/*.in'),
    'SConscript',
    'maketgz',
    'Makefile.in',
    'lib/wildcard.h',
    'lib/mk-ca-bundle.pl',
    'lib/telnet.c',
    'lib/strequal.c',
    'lib/http_chunks.h',
    'lib/openldap.c',
    'lib/hostip6.c',
    'lib/dotdot.c',
    'lib/ssh.c',
    'lib/config-vxworks.h',
    'lib/sigpipe.h',
    'lib/strequal.h',
    'lib/Makefile.in',
    'lib/Makefile.b32',
    'lib/config-tpf.h',
    'lib/memdebug.c',
    'lib/curlx.h',
    'lib/gopher.c',
    'lib/warnless.c',
    'lib/curl_sspi.c',
    'lib/rawstr.c',
    'lib/easyif.h',
    'lib/smtp.h',
    'lib/hmac.c',
    'lib/formdata.c',
    'lib/config-win32ce.h',
    'lib/nonblock.c',
    'lib/asyn.h',
    'lib/llist.h',
    'lib/x509asn1.h',
    'lib/curl_ntlm_core.h',
    'lib/socks_gssapi.c',
    'lib/socks_sspi.c',
    'lib/fileinfo.h',
    'lib/curl_memrchr.c',
    'lib/non-ascii.c',
    'lib/curl_ntlm.h',
    'lib/asyn-ares.c',
    'lib/parsedate.c',
    'lib/select.c',
    'lib/arpa_telnet.h',
    'lib/dict.c',
    'lib/curl_rtmp.c',
    'lib/README.pipelining',
    'lib/curl_fnmatch.c',
    'lib/netrc.h',
    'lib/curl_ntlm_wb.c',
    'lib/connect.h',
    'lib/gopher.h',
    'lib/Makefile.Watcom',
    'lib/curl_setup_once.h',
    'lib/if2ip.c',
    'lib/if2ip.h',
    'lib/md4.c',
    'lib/escape.h',
    'lib/dict.h',
    'lib/Makefile.am',
    'lib/README.curl_off_t',
    'lib/firefox-db2pem.sh',
    'lib/version.c',
    'lib/Makefile.vc9',
    'lib/CMakeLists.txt',
    'lib/strdup.h',
    'lib/base64.c',
    'lib/escape.c',
    'lib/idn_win32.c',
    'lib/fileinfo.c',
    'lib/curl_sasl.c',
    'lib/http_digest.c',
    'lib/config-dos.h',
    'lib/curl_gethostname.c',
    'lib/curl_threads.h',
    'lib/tftp.c',
    'lib/imap.h',
    'lib/mk-ca-bundle.vbs',
    'lib/transfer.c',
    'lib/makefile.amiga',
    'lib/inet_pton.h',
    'lib/config-mac.h',
    'lib/hostip4.c',
    'lib/slist.c',
    'lib/Makefile.netware',
    'lib/curl_gethostname.h',
    'lib/README.encoding',
    'lib/README.hostip',
    'lib/inet_pton.c',
    'lib/hostcheck.c',
    'lib/url.h',
    'lib/curl_gssapi.c',
    'lib/curl_threads.c',
    'lib/speedcheck.c',
    'lib/libcurl.vers.in',
    'lib/md5.c',
    'lib/non-ascii.h',
    'lib/http_chunks.c',
    'lib/pop3.h',
    'lib/http.h',
    'lib/curl_config.h.in',
    'lib/curl_multibyte.c',
    'lib/strerror.c',
    'lib/multihandle.h',
    'lib/netrc.c',
    'lib/rtsp.c',
    'lib/rawstr.h',
    'lib/socks.h',
    'lib/sockaddr.h',
    'lib/Makefile.m32',
    'lib/share.h',
    'lib/curl_multibyte.h',
    'lib/ssh.h',
    'lib/curl_ldap.h',
    'lib/inet_ntop.c',
    'lib/config-os400.h',
    'lib/mprintf.c',
    'lib/hostcheck.h',
    'lib/http2.c',
    'lib/urldata.h',
    'lib/conncache.h',
    'lib/http_proxy.h',
    'lib/nonblock.h',
    'lib/objnames.inc',
    'lib/hostip.h',
    'lib/pingpong.h',
    'lib/curl_config.h.cmake',
    'lib/curl_setup.h',
    'lib/sendf.c',
    'lib/amigaos.c',
    'lib/ldap.c',
    'lib/objnames-test08.sh',
    'lib/llist.c',
    'lib/README.httpauth',
    'lib/pipeline.c',
    'lib/curl_sasl.h',
    'lib/memdebug.h',
    'lib/http_digest.h',
    'lib/http2.h',
    'lib/http_negotiate_sspi.c',
    'lib/getinfo.h',
    'lib/curl_memrchr.h',
    'lib/smtp.c',
    'lib/config-amigaos.h',
    'lib/ftplistparser.c',
    'lib/select.h',
    'lib/curl_fnmatch.h',
    'lib/README.memoryleak',
    'lib/nwos.c',
    'lib/objnames-test10.sh',
    'lib/libcurl.plist',
    'lib/README.ares',
    'lib/strtoofft.h',
    'lib/wildcard.c',
    'lib/content_encoding.c',
    'lib/krb5.c',
    'lib/checksrc.pl',
    'lib/Makefile.inc',
    'lib/imap.c',
    'lib/progress.h',
    'lib/hostasyn.c',
    'lib/config-riscos.h',
    'lib/http.c',
    'lib/curl_sec.h',
    'lib/parsedate.h',
    'lib/hostsyn.c',
    'lib/makefile.dj',
    'lib/share.c',
    'lib/tftp.h',
    'lib/warnless.h',
    'lib/getenv.c',
    'lib/curl_hmac.h',
    'lib/curl_addrinfo.c',
    'lib/hostip.c',
    'lib/Makefile.vc10',
    'lib/config-win32.h',
    'lib/http_negotiate.c',
    'lib/x509asn1.c',
    'lib/asyn-thread.c',
    'lib/libcurl.rc',
    'lib/hash.h',
    'lib/connect.c',
    'lib/dotdot.h',
    'lib/setup-vms.h',
    'lib/README.curlx',
    'lib/bundles.c',
    'lib/amigaos.h',
    'lib/curl_ntlm_core.c',
    'lib/slist.h',
    'lib/strtok.c',
    'lib/ftp.h',
    'lib/curl_base64.h',
    'lib/nwlib.c',
    'lib/README.pingpong',
    'lib/cookie.h',
    'lib/speedcheck.h',
    'lib/pingpong.c',
    'lib/curl_addrinfo.h',
    'lib/vtls/vtls.c',
    'lib/vtls/curl_schannel.c',
    'lib/vtls/gskit.h',
    'lib/vtls/polarssl.c',
    'lib/vtls/gskit.c',
    'lib/vtls/cyassl.c',
    'lib/vtls/qssl.c',
    'lib/vtls/openssl.c',
    'lib/vtls/openssl.h',
    'lib/vtls/polarssl_threadlock.c',
    'lib/vtls/curl_darwinssl.c',
    'lib/vtls/vtls.h',
    'lib/vtls/cyassl.h',
    'lib/vtls/polarssl.h',
    'lib/vtls/gtls.c',
    'lib/vtls/axtls.c',
    'lib/vtls/nss.c',
    'lib/vtls/nssg.h',
    'lib/vtls/curl_darwinssl.h',
    'lib/vtls/axtls.h',
    'lib/vtls/polarssl_threadlock.h',
    'lib/vtls/curl_schannel.h',
    'lib/vtls/gtls.h',
    'lib/vtls/qssl.h',
    'lib/file.c',
    'lib/Makefile.vxworks',
    'lib/strdup.c',
    'lib/inet_ntop.h',
    'lib/setup-os400.h',
    'lib/splay.c',
    'lib/strtok.h',
    'lib/multi.c',
    'lib/easy.c',
    'lib/ftp.c',
    'lib/config-symbian.h',
    'lib/telnet.h',
    'lib/timeval.c',
    'lib/curl_ntlm_msgs.h',
    'lib/curl_sspi.h',
    'lib/Makefile.vc8',
    'lib/curl_ntlm_wb.h',
    'lib/cookie.c',
    'lib/security.c',
    'lib/strerror.h',
    'lib/pop3.c',
    'lib/curl_ntlm_msgs.c',
    'lib/http_negotiate.h',
    'lib/curl_md4.h',
    'lib/ftplistparser.h',
    'lib/timeval.h',
    'lib/progress.c',
    'lib/rtsp.h',
    'lib/curl_gssapi.h',
    'lib/hash.c',
    'lib/curl_memory.h',
    'lib/socks.c',
    'lib/curl_rtmp.h',
    'lib/bundles.h',
    'lib/content_encoding.h',
    'lib/curl_ntlm.c',
    'lib/sendf.h',
    'lib/README.multi_socket',
    'lib/conncache.c',
    'lib/multiif.h',
    'lib/url.c',
    'lib/splay.h',
    'lib/transfer.h',
    'lib/formdata.h',
    'lib/Makefile.vc6',
    'lib/getinfo.c',
    'lib/curl_md5.h',
    'lib/http_proxy.c',
    'lib/file.h',
    'lib/strtoofft.c',
    'lib/pipeline.h',
    'm4/xc-cc-check.m4',
    'm4/zz50-xc-ovr.m4',
    'm4/curl-override.m4',
    'm4/xc-val-flgs.m4',
    'm4/curl-openssl.m4',
    'm4/curl-reentrant.m4',
    'm4/libtool.m4',
    'm4/curl-compilers.m4',
    'm4/curl-functions.m4',
    'm4/xc-lt-iface.m4',
    'm4/ltversion.m4',
    'm4/lt~obsolete.m4',
    'm4/zz40-xc-ovr.m4',
    'm4/zz60-xc-ovr.m4',
    'm4/xc-translit.m4',
    'm4/curl-confopts.m4',
    'm4/xc-am-iface.m4',
    'm4/ltsugar.m4',
    'm4/ltoptions.m4',
    'config.guess',
    'mkinstalldirs',
    'Makefile.am',
    'compile',
    'CMakeLists.txt',
    'vs/vc6/lib/vc6libcurl.dsp',
    'vs/vc6/lib/vc6libcurl.dsw',
    'vs/vc6/vc6curl.dsw',
    'vs/vc6/src/vc6curltool.dsw',
    'vs/vc6/src/vc6curltool.dsp',
    'vs/vc8/lib/vc8libcurl.vcproj',
    'vs/t/lib/vc6_libcurl_dsp.foot',
    'vs/t/lib/vc6_libcurl_dsp.head',
    'vs/t/lib/vc8_libcurl_prj.head',
    'vs/t/lib/vc8_libcurl_prj.foot',
    'vs/t/README',
    'configure',
    'configure.ac',
    'acinclude.m4',
    'curl-config.in',
    'COPYING',
    'README',
    'MacOSX-Framework',
    'RELEASE-NOTES',
    'install-sh',
    'src/curl.rc',
    'src/tool_formparse.c',
    'src/tool_hugehelp.c',
    'src/tool_cb_rea.h',
    'src/Makefile.in',
    'src/tool_cfgable.h',
    'src/Makefile.b32',
    'src/version.h',
    'src/tool_mfiles.c',
    'src/tool_version.h',
    'src/tool_easysrc.h',
    'src/tool_cb_see.h',
    'src/tool_cb_rea.c',
    'src/tool_cb_dbg.h',
    'src/tool_convert.c',
    'src/tool_xattr.c',
    'src/tool_parsecfg.c',
    'src/macos/src/macos_main.cpp',
    'src/macos/src/curl_GUSIConfig.cpp',
    'src/macos/curl.mcp.xml.sit.hqx',
    'src/macos/MACINSTALL.TXT',
    'src/tool_libinfo.h',
    'src/tool_writeout.h',
    'src/tool_bname.h',
    'src/tool_parsecfg.h',
    'src/tool_homedir.h',
    'src/tool_dirhie.h',
    'src/tool_setopt.c',
    'src/Makefile.Watcom',
    'src/tool_operate.h',
    'src/Makefile.am',
    'src/Makefile.vc9',
    'src/CMakeLists.txt',
    'src/makefile.amiga',
    'src/tool_metalink.c',
    'src/Makefile.netware',
    'src/tool_formparse.h',
    'src/tool_xattr.h',
    'src/tool_writeenv.c',
    'src/tool_cb_see.c',
    'src/tool_main.c',
    'src/tool_msgs.c',
    'src/tool_binmode.h',
    'src/tool_cb_wrt.c',
    'src/tool_getpass.c',
    'src/tool_hugehelp.h',
    'src/Makefile.m32',
    'src/mkhelp.pl',
    'src/tool_cb_wrt.h',
    'src/tool_sdecls.h',
    'src/tool_binmode.c',
    'src/tool_writeout.c',
    'src/tool_panykey.h',
    'src/tool_cb_hdr.h',
    'src/tool_operhlp.c',
    'src/tool_panykey.c',
    'src/tool_sleep.c',
    'src/tool_msgs.h',
    'src/tool_getparam.h',
    'src/tool_libinfo.c',
    'src/tool_mfiles.h',
    'src/tool_vms.h',
    'src/tool_urlglob.c',
    'src/tool_helpers.h',
    'src/tool_util.c',
    'src/tool_cb_prg.h',
    'src/tool_help.h',
    'src/tool_convert.h',
    'src/tool_cfgable.c',
    'src/tool_operate.c',
    'src/tool_bname.c',
    'src/tool_doswin.h',
    'src/tool_helpers.c',
    'src/Makefile.inc',
    'src/tool_urlglob.h',
    'src/makefile.dj',
    'src/tool_cb_dbg.c',
    'src/Makefile.vc10',
    'src/tool_getpass.h',
    'src/tool_dirhie.c',
    'src/tool_homedir.c',
    'src/tool_vms.c',
    'src/tool_getparam.c',
    'src/tool_paramhlp.h',
    'src/tool_setopt.h',
    'src/tool_easysrc.c',
    'src/tool_paramhlp.c',
    'src/Makefile.vc8',
    'src/tool_main.h',
    'src/tool_setup.h',
    'src/tool_util.h',
    'src/tool_sleep.h',
    'src/tool_doswin.c',
    'src/tool_cb_hdr.c',
    'src/tool_help.c',
    'src/tool_operhlp.h',
    'src/tool_metalink.h',
    'src/Makefile.vc6',
    'src/tool_writeenv.h',
    'src/tool_cb_prg.c',
    'buildconf',
    'depcomp',
    'CHANGES',
    'CMake/CMakeConfigurableFile.in',
    'CMake/FindOpenSSL.cmake',
    'CMake/FindZLIB.cmake',
    'CMake/Platforms/WindowsCache.cmake',
    'CMake/CurlCheckCSourceCompiles.cmake',
    'CMake/OtherTests.cmake',
    'CMake/Utilities.cmake',
    'CMake/CurlCheckCSourceRuns.cmake',
    'CMake/CurlTests.c',
    'aclocal.m4',
    'ltmain.sh',
    'winbuild/Makefile.vc',
    'winbuild/gen_resp_file.bat',
    'winbuild/Makefile.msvc.names',
    'winbuild/BUILD.WINDOWS.txt',
    'winbuild/MakefileBuild.vc',
    'config.sub',
    'libcurl.pc.in',
    'include/Makefile.in',
    'include/Makefile.am',
    'include/README',
    'include/curl/curlbuild.h.cmake',
    'include/curl/Makefile.in',
    'include/curl/multi.h',
    'include/curl/typecheck-gcc.h',
    'include/curl/curl.h',
    'include/curl/Makefile.am',
    'include/curl/curlrules.h',
    'include/curl/easy.h',
    'include/curl/curlver.h',
    'include/curl/mprintf.h',
    'include/curl/curlbuild.h',
    'include/curl/curlbuild.h.in',
    'include/curl/stdcheaders.h',
    'missing',
]

config = env.Command(target = ['Makefile', 'lib/curl_config.h'], source = sources, action = config_command)
libcurl = env.Command(target = [os.path.join(env["install_path"], "lib/libcurl.a"),
                                os.path.join(env["install_path"], "lib/libcurl.so"),
                                os.path.join(env["install_path"], "include/curl/curl.h")],
                      source = sources + [config], action = build_command)
Return('libcurl')
